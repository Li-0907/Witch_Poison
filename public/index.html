<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥³å·«çš„æ¯’è¯è›‹ç³•</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>

<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-hat-wizard"></i> å¥³å·«çš„æ¯’è¯è›‹ç³•</h1>
      <p class="subtitle">åŒäººå¯¹æˆ˜æ¸¸æˆ - é€‰æ‹©ä½ çš„æ¯’è¯ï¼Œé¿å¼€å¯¹æ‰‹çš„é™·é˜±</p>
    </header>

    <div class="game-area">
      <div id="sounds" class="sounds"><i class="fas fa-volume-xmark"></i></div>
      <!-- ä¸»èœå•å±å¹• -->
      <div id="main-menu" class="screen active">
        <div class="instructions">
          <h3><i class="fas fa-book"></i> æ¸¸æˆè§„åˆ™</h3>
          <ul>
            <li><strong>ç›®æ ‡</strong>: é¿å…é€‰ä¸­ä»»ä½•æ¯’è¯è›‹ç³•ï¼Œè®©å¯¹æ‰‹é€‰ä¸­æ¯’è¯</li>
            <li><strong>è®¾ç½®é˜¶æ®µ</strong>:
              <ul>
                <li>æˆ¿ä¸»åˆ›å»ºæˆ¿é—´å¹¶è®¾ç½®è›‹ç³•ç½‘æ ¼å¤§å°</li>
                <li>å…¶ä»–ç©å®¶é€šè¿‡4ä½æˆ¿é—´å·åŠ å…¥</li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="form-group">
          <button id="create-room-btn" class="btn-primary">
            <i class="fas fa-plus-circle"></i> åˆ›å»ºæˆ¿é—´
          </button>
        </div>

        <div class="form-group">
          <p style="text-align: center; margin: 20px 0;">æˆ–</p>
          <button id="join-room-btn" class="btn-secondary">
            <i class="fas fa-sign-in-alt"></i> åŠ å…¥æˆ¿é—´
          </button>
        </div>
      </div>

      <!-- åˆ›å»ºæˆ¿é—´å±å¹• -->
      <div id="create-room-screen" class="screen">
        <h2><i class="fas fa-home"></i> åˆ›å»ºæˆ¿é—´</h2>

        <div class="form-group">
          <label for="room-id">æˆ¿é—´å· (4ä½æ•°å­—)</label>
          <input type="number" id="room-id" maxlength="4" placeholder="ä¾‹å¦‚: 1234">
        </div>

        <!-- <div class="form-group">
          <label for="grid-size">è›‹ç³•ç½‘æ ¼å¤§å° (NÃ—N)</label>
          <select id="grid-size">
            <option value="4">4Ã—4 (16ä¸ªè›‹ç³•)</option>
            <option value="5" selected>5Ã—5 (25ä¸ªè›‹ç³•)</option>
            <option value="6">6Ã—6 (36ä¸ªè›‹ç³•)</option>
            <option value="7">7Ã—7 (49ä¸ªè›‹ç³•)</option>
            <option value="8">8Ã—8 (64ä¸ªè›‹ç³•)</option>
          </select>
        </div> -->

        <div class="form-group">
          <button id="create-room-confirm-btn" class="btn-primary">
            <i class="fas fa-magic"></i> åˆ›å»ºæˆ¿é—´
          </button>
          <button id="back-to-menu-btn" class="btn-secondary leave-room-btn">
            <i class="fas fa-arrow-left"></i> è¿”å›ä¸»èœå•
          </button>
        </div>
      </div>

      <!-- åŠ å…¥æˆ¿é—´å±å¹• -->
      <div id="join-room-screen" class="screen">
        <h2><i class="fas fa-door-open"></i> åŠ å…¥æˆ¿é—´</h2>

        <div class="form-group">
          <label for="join-room-id">è¾“å…¥æˆ¿é—´å·</label>
          <input type="number" id="join-room-id" maxlength="4" placeholder="è¯·è¾“å…¥4ä½æ•°å­—">
        </div>

        <div class="form-group">
          <button id="join-room-confirm-btn" class="btn-primary">
            <i class="fas fa-sign-in-alt"></i> åŠ å…¥æˆ¿é—´
          </button>
          <button id="back-to-menu-btn-2" class="btn-secondary leave-room-btn">
            <i class="fas fa-arrow-left"></i> è¿”å›ä¸»èœå•
          </button>
        </div>
      </div>

      <!-- ç­‰å¾…ç©å®¶å±å¹• -->
      <div id="waiting-screen" class="screen">
        <h2><i class="fas fa-hourglass-half"></i> ç­‰å¾…ç©å®¶åŠ å…¥</h2>

        <div class="room-info">
          <p><i class="fas fa-door-closed"></i> æˆ¿é—´å·: <span id="waiting-room-id">----</span></p>
          <p><i class="fas fa-user"></i> çŠ¶æ€: <span id="waiting-status">ç­‰å¾…ç©å®¶åŠ å…¥...</span></p>
        </div>

        <div class="form-group">
          <button id="cancel-waiting-btn" class="btn-secondary leave-room-btn">
            <i class="fas fa-times"></i> å–æ¶ˆå¹¶è¿”å›
          </button>
        </div>
      </div>

      <!-- æ¸¸æˆå±å¹• -->
      <div id="game-screen" class="screen">
        <div class="room-info">
          <p><i class="fas fa-door-closed"></i> æˆ¿é—´å·: <span id="game-room-id">----</span> |
            <i class="fas fa-user"></i> ä½ çš„è§’è‰²: <span id="player-role">---</span>
          </p>
        </div>

        <div class="players-info">
          <div id="host-card" class="player-card host">
            <div class="player-name">æˆ¿ä¸»</div>
            <div class="player-status" id="host-status">ç­‰å¾…ä¸­...</div>
          </div>

          <div id="guest-card" class="player-card guest">
            <div class="player-name">ç©å®¶2</div>
            <div class="player-status" id="guest-status">ç­‰å¾…ä¸­...</div>
          </div>
        </div>

        <!-- æ·»åŠ æ¸¸æˆè®¾ç½®åŒºåŸŸï¼Œåªæœ‰æˆ¿ä¸»ä¸”æ¸¸æˆæœªå¼€å§‹æ—¶æ˜¾ç¤º -->
        <div id="game-setup" class="game-setup" style="display: none;">
          <h3><i class="fas fa-cog"></i> æ¸¸æˆè®¾ç½®</h3>
          <div class="form-group">
            <label for="grid-size-select">è›‹ç³•ç½‘æ ¼å¤§å° (NÃ—N)</label>
            <select id="grid-size-select">
              <option value="3">3Ã—3 (9ä¸ªè›‹ç³•)</option>
              <option value="4">4Ã—4 (16ä¸ªè›‹ç³•)</option>
              <option value="5" selected>5Ã—5 (25ä¸ªè›‹ç³•)</option>
              <option value="6">6Ã—6 (36ä¸ªè›‹ç³•)</option>
              <option value="7">7Ã—7 (49ä¸ªè›‹ç³•)</option>
              <option value="8">8Ã—8 (64ä¸ªè›‹ç³•)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="who-go-first-select">å…ˆæ‰‹è®¾ç½®</label>
            <select id="who-go-first-select">
              <option value="random">éšæœº</option>
              <option value="win" selected>èµ¢è€…å…ˆ</option>
              <option value="lose">è¾“è€…å…ˆ</option>
              <option value="host">æˆ¿ä¸»å…ˆ</option>
              <option value="guest">ç©å®¶2å…ˆ</option>
            </select>
          </div>
          <button id="start-game-btn" class="btn-primary">
            <i class="fas fa-play"></i> å¼€å§‹æ¸¸æˆ
          </button>
        </div>

        <div class="game-status">
          <div id="status-message" class="status-message">æ¸¸æˆå³å°†å¼€å§‹</div>
          <div id="turn-indicator" class="turn-indicator"></div>
        </div>

        <div id="game-over-screen" class="game-over" style="display: none;">
          <div id="winner-message" class="winner">æ¸¸æˆç»“æŸ!</div>
          <div id="result-details" class="result-details"></div>
          <div class="form-group">
            <button id="play-again-btn" class="btn-primary">
              <i class="fas fa-redo"></i> å†ç©ä¸€æ¬¡
            </button>
            <button id="exit-game-btn" class="btn-secondary leave-room-btn">
              <i class="fas fa-sign-out-alt"></i> é€€å‡ºæ¸¸æˆ
            </button>
          </div>
        </div>

        <div id="cake-grid-container" style="display: none;">
          <div id="cake-grid" class="cake-grid"></div>
        </div>

        
      </div>


    </div>
  </div>

  <script>
    // WebSocketè¿æ¥
    let ws;
    let playerRole = '';
    let roomId = '';
    let gridSize = 5;
    let myPoisonPosition = null;
    let gameState = '';
    let isMyTurn = false;
    let soundsEnabled = localStorage.getItem('soundsEnabled') === 'false' ? false : true;
    let selectedCakes = new Set();
    let mySelectedCakes = new Set();

    // DOMå…ƒç´ 
    const screens = {
      mainMenu: document.getElementById('main-menu'),
      createRoom: document.getElementById('create-room-screen'),
      joinRoom: document.getElementById('join-room-screen'),
      waiting: document.getElementById('waiting-screen'),
      game: document.getElementById('game-screen')
    };

    // åˆ‡æ¢å±å¹•
    function showScreen(screenName) {
      Object.keys(screens).forEach(key => {
        screens[key].classList.remove('active');
      });
      screens[screenName].classList.add('active');
    }

    // è¿æ¥WebSocketæœåŠ¡å™¨
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('å·²è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleServerMessage(data);
      };

      ws.onclose = () => {
        console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
        Toastify({
          text: "ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•",
          duration: 3000,
          gravity: "top",
          position: "center",
          stopOnFocusLoss: true,
          style: {
            background: "linear-gradient(to right, #ff4757, #ff4757)",
          },
        }).showToast();
        // alert('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      };

      ws.onerror = (error) => {
        console.error('WebSocketé”™è¯¯:', error);
      };
    }

    // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
    function handleServerMessage(data) {
      console.log('æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:', data);

      switch (data.type) {
        case 'room_created':
          resetGameState(); // é‡ç½®çŠ¶æ€åå†è®¾ç½®æ–°æˆ¿é—´
          playerRole = 'host';
          roomId = data.roomId;
          gameState = 'waiting';
          updateGameScreen();
          showScreen('game');
          break;

        case 'player_joined':
          resetGameState(); // é‡ç½®çŠ¶æ€åå†åŠ å…¥æˆ¿é—´
          playerRole = data.role;
          roomId = data.roomId;
          gameState = data.state;
          // æ’­æ”¾ç©å®¶åŠ å…¥éŸ³æ•ˆ
          playSound('player-join');
          updateGameScreen();
          showScreen('game');
          break;

        case 'error':
          Toastify({
            text: 'é”™è¯¯: ' + data.message,
            duration: 3000,
            gravity: "top",
            position: "center",
            stopOnFocusLoss: true,
            style: {
              background: "linear-gradient(to right, #ff4757, #ff4757)",
            },
          }).showToast();
          // alert('é”™è¯¯: ' + data.message);
          break;

        case 'game_started':
          playSound('game_start');
          gridSize = data.gridSize;
          gameState = data.state;
          isMyTurn = data.isTurn;
          updateGameScreen();
          createCakeGrid();
          break;

        case 'poison_chosen':
          // ç©å®¶è‡ªå·±é€‰æ‹©äº†æ¯’è¯
          gameState = 'choosing_poison';
          myPoisonPosition = data.yourPoison;
          isMyTurn = false; // æ¯’è¯é€‰æ‹©é˜¶æ®µæ²¡æœ‰å›åˆæ¦‚å¿µ
          updateCakeGrid();
          updateGameScreen();
          break;

        case 'opponent_poison_chosen':
          // å¯¹æ‰‹é€‰æ‹©äº†æ¯’è¯
          playSound('opponent_poison_chosen');
          Toastify({
            text: "å¯¹æ‰‹é€‰æ‹©äº†æ¯’è¯",
            duration: 3000,
            gravity: "top",
            position: "center",
            stopOnFocusLoss: true,
          }).showToast();
          gameState = 'choosing_poison';
          updateGameScreen();
          break;

        case 'all_poisons_chosen':
          // åŒæ–¹éƒ½é€‰æ‹©äº†æ¯’è¯ï¼Œæ¸¸æˆå¼€å§‹
          gameState = 'playing';
          myPoisonPosition = data.yourPoison;
          isMyTurn = data.isTurn;
          updateCakeGrid();
          updateGameScreen();
          break;

        case 'cake_selected':
          selectedCakes = new Set(data.selectedCakes);
          isMyTurn = data.isTurn;
          if (isMyTurn) {
            playSound('cake_selected');
          }
          if (!isMyTurn) {
            updateMySelectCake(data.selectedPosition.join(','));
          }
          updateCakeGrid();
          updateGameScreen();
          break;

        case 'game_over':
          gameState = 'finished';
          showGameOver(data);
          showScore(data.lastWinners);
          break;

        case 'game_restarted':
          playSound('game_start');
          gridSize = data.gridSize;
          gameState = data.state;
          isMyTurn = data.isTurn;
          myPoisonPosition = null;
          selectedCakes = new Set();
          resetGameScreen();
          createCakeGrid();
          break;

        case 'opponent_disconnected':
          playSound('disconnect');
          Toastify({
            text: "å¯¹æ‰‹å·²æ–­å¼€è¿æ¥",
            duration: 3000,
            gravity: "top",
            position: "center",
            stopOnFocusLoss: true,
            style: {
              background: "linear-gradient(to right, #ff4757, #ff4757)",
            },
          }).showToast();
          if (ws && ws.readyState === WebSocket.OPEN && roomId) {
            sendMessage('leave_room', {});
          }
          resetGameState();
          showScreen('mainMenu');
          break;

        case 'room_left':
          // æˆåŠŸç¦»å¼€æˆ¿é—´ï¼Œä¸éœ€è¦é¢å¤–æ“ä½œ
          console.log('å·²ç¦»å¼€æˆ¿é—´');
          break;
        case 'request_restart_game':
          handleRequestRestartGame(data);
      }
    }

    // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
    function sendMessage(type, data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = { type, ...data };
        ws.send(JSON.stringify(message));
      } else {
        Toastify({
          text: "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•",
          duration: 3000,
          gravity: "top",
          position: "center",
          stopOnFocusLoss: true,
          style: {
            background: "linear-gradient(to right, #ff4757, #ff4757)",
          },
        }).showToast();
        // alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    function updateMySelectCake(position) {
      if (!mySelectedCakes.has(position)) {
        mySelectedCakes.add(position);
      }
    }

    function showScore(lastWinners) {
      const hostWins = lastWinners.reduce((pre, cur) => cur === 'host' ? pre + 1: pre, 0);
      const guestWin = lastWinners.length - hostWins;
      const hostCard = document.getElementById('host-card');
      let hostScore = hostCard.querySelector('.score');
      if (!hostScore) {
        hostScore = document.createElement('div');
        hostScore.classList.add('score');
      }
      hostScore.innerHTML = `å¾—åˆ†: ${hostWins}`;

      const guestCard = document.getElementById('guest-card');
      let guestScore = guestCard.querySelector('.score');
      if (!guestScore) {
        guestScore = document.createElement('div');
        guestScore.classList.add('score');
      }
      guestScore.innerHTML = `å¾—åˆ†: ${guestWin}`;

      hostCard.appendChild(hostScore);
      guestCard.appendChild(guestScore);
      
    }

    // æ›´æ–°æ¸¸æˆå±å¹•
    function updateGameScreen() {
      document.getElementById('game-room-id').textContent = roomId;
      document.getElementById('player-role').textContent = playerRole === 'host' ? 'æˆ¿ä¸»' : 'ç©å®¶2';

      // æ›´æ–°ç©å®¶å¡ç‰‡
      const hostCard = document.getElementById('host-card');
      const guestCard = document.getElementById('guest-card');
      const hostStatus = document.getElementById('host-status');
      const guestStatus = document.getElementById('guest-status');
      const gameSetup = document.getElementById('game-setup');

      if (playerRole === 'host') {
        hostCard.classList.add('you');
        guestCard.classList.remove('you');
        hostStatus.textContent = 'ä½ ';
        guestStatus.textContent = gameState === 'waiting' ? 'ç­‰å¾…ä¸­...' : 'å·²åŠ å…¥';
        guestCard.style.borderColor = gameState === 'waiting' ? 'red' : 'green';

        // å¦‚æœæ˜¯æˆ¿ä¸»ä¸”æ¸¸æˆçŠ¶æ€ä¸ºç­‰å¾…ï¼Œæ˜¾ç¤ºæ¸¸æˆè®¾ç½®
        if (gameState === 'waiting' || gameState === 'setting_cakes') {
          gameSetup.style.display = 'block';
        } else {
          gameSetup.style.display = 'none';
        }
      } else {
        hostCard.classList.remove('you');
        guestCard.classList.add('you');
        hostStatus.textContent = 'å·²åŠ å…¥';
        guestStatus.textContent = 'ä½ ';
        gameSetup.style.display = 'none'; // è®¿å®¢ä¸æ˜¾ç¤ºæ¸¸æˆè®¾ç½®
      }

      // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
      const statusMessage = document.getElementById('status-message');
      const turnIndicator = document.getElementById('turn-indicator');
      const gridContainer = document.getElementById('cake-grid-container');

      if (gameState === 'waiting' || gameState === 'setting_cakes') {
        if (playerRole === 'host') {
          statusMessage.textContent = 'è¯·è®¾ç½®è›‹ç³•ç½‘æ ¼å¤§å°';
        } else {
          statusMessage.textContent = 'ç­‰å¾…æˆ¿ä¸»è®¾ç½®æ¸¸æˆ...';
        }
        turnIndicator.textContent = '';
        gridContainer.style.display = 'none';
      } else if (gameState === 'choosing_poison') {
        gridContainer.style.display = 'block';
        if (myPoisonPosition) {
          statusMessage.textContent = 'ä½ å·²é€‰æ‹©æ¯’è¯ï¼Œç­‰å¾…å¯¹æ‰‹é€‰æ‹©...';
          turnIndicator.textContent = '';
        } else {
          statusMessage.textContent = 'è¯·é€‰æ‹©ä½ çš„æ¯’è¯è›‹ç³•';
          turnIndicator.textContent = 'ç‚¹å‡»è›‹ç³•é€‰æ‹©æ¯’è¯';
        }
      } else if (gameState === 'playing') {
        gridContainer.style.display = 'block';
        if (isMyTurn) {
          statusMessage.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªè›‹ç³•';
          turnIndicator.textContent = 'è½®åˆ°ä½ äº†ï¼';
        } else {
          statusMessage.textContent = 'ç­‰å¾…å¯¹æ‰‹é€‰æ‹©...';
          turnIndicator.textContent = 'å¯¹æ‰‹çš„å›åˆ';
        }
      } else if (gameState === 'finished') {
        gridContainer.style.display = 'none';
        turnIndicator.textContent = '';
      }
    }

    // é¢„åŠ è½½å’Œç¼“å­˜éŸ³é¢‘å¯¹è±¡
    const audioCache = new Map();

    // é¢„åŠ è½½å¸¸ç”¨éŸ³æ•ˆ
    function preloadSounds(soundNames) {
      soundNames.forEach(name => {
        if (!audioCache.has(name)) {
          const audio = new Audio(`./sounds/${name}.mp3`);
          audio.load(); // é¢„åŠ è½½
          audioCache.set(name, audio);
        }
      });
    }

    // æ’­æ”¾éŸ³æ•ˆ
    function playSound(soundName) {
      if (!soundsEnabled) return;

      let audio = audioCache.get(soundName);

      if (!audio) {
        // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ›å»ºå¹¶ç¼“å­˜
        audio = new Audio(`./sounds/${soundName}.mp3`);
        audioCache.set(soundName, audio);
      } else {
        // é‡ç½®æ’­æ”¾ä½ç½®
        audio.currentTime = 0;
      }

      // å¤„ç†æ’­æ”¾å¤±è´¥çš„æƒ…å†µ
      audio.play().catch(error => {
        console.warn(`Failed to play sound ${soundName}:`, error);
      });
    }

    // åœ¨æ¸¸æˆ/åº”ç”¨åˆå§‹åŒ–æ—¶é¢„åŠ è½½å¸¸ç”¨éŸ³æ•ˆ
    preloadSounds(['player-join', 'disconnect', 'game_start', 'cake_selected', 'opponent_poison_chosen', 'win', 'lose']);

    // é‡ç½®æ¸¸æˆå±å¹•
    function resetGameScreen() {
      document.getElementById('game-over-screen').style.display = 'none';
      document.getElementById('cake-grid-container').style.display = 'block';
      updateGameScreen();
    }

    // åˆ›å»ºè›‹ç³•ç½‘æ ¼
    function createCakeGrid() {
      const cakeGrid = document.getElementById('cake-grid');
      cakeGrid.innerHTML = '';

      // è®¾ç½®ç½‘æ ¼æ ·å¼
      cakeGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

      // åˆ›å»ºè›‹ç³•å•å…ƒæ ¼
      for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
          const cell = document.createElement('div');
          cell.className = 'cake-cell';
          cell.dataset.row = row;
          cell.dataset.col = col;

          // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©
          const posKey = `${row},${col}`;
          if (selectedCakes.has(posKey)) {
            cell.classList.add('selected');
            cell.onclick = null;
          } else {
            // åœ¨æ¯’è¯é€‰æ‹©é˜¶æ®µï¼Œæ‰€æœ‰æœªé€‰æ‹©çš„è›‹ç³•éƒ½å¯ä»¥ç‚¹å‡»
            if (gameState === 'choosing_poison' && !myPoisonPosition) {
              cell.onclick = () => handleCakeClick(row, col);
            }
          }

          cakeGrid.appendChild(cell);
        }
      }

      document.getElementById('cake-grid-container').style.display = 'block';
    }

    // æ›´æ–°è›‹ç³•ç½‘æ ¼
    function updateCakeGrid() {
      const cakeCells = document.querySelectorAll('.cake-cell');
      cakeCells.forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        const posKey = `${row},${col}`;

        // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        cell.onclick = null;

        // å¦‚æœè›‹ç³•å·²è¢«é€‰æ‹©ï¼Œæ ‡è®°ä¸ºå·²é€‰æ‹©
        if (selectedCakes.has(posKey)) {
          cell.classList.add('selected');
          cell.onclick = null;
          if (mySelectedCakes.has(posKey)) {
            cell.classList.add('your-select-cake');
          }
        } else if (gameState === 'playing' && isMyTurn) {
          // åªæœ‰åœ¨æ¸¸æˆè¿›è¡Œä¸­ä¸”è½®åˆ°ç©å®¶æ—¶æ‰èƒ½ç‚¹å‡»
          cell.onclick = () => handleCakeClick(row, col);
        } else if (gameState === 'choosing_poison' && !myPoisonPosition) {
          // åœ¨æ¯’è¯é€‰æ‹©é˜¶æ®µä¸”è¿˜æœªé€‰æ‹©æ¯’è¯æ—¶æ‰èƒ½ç‚¹å‡»
          cell.onclick = () => handleCakeClick(row, col);
        }

        // å¦‚æœè¿™ä¸ªä½ç½®æ˜¯ç©å®¶è‡ªå·±çš„æ¯’è¯ï¼Œæ ‡è®°ä¸ºæ¯’è¯ï¼ˆä»…åœ¨é€‰æ‹©åæ˜¾ç¤ºï¼‰
        if (myPoisonPosition && myPoisonPosition[0] === row && myPoisonPosition[1] === col) {
          cell.classList.add('your-poison');
          // æ·»åŠ æ¯’è¯å›¾æ ‡
          if (!cell.classList.contains('selected')) {
            cell.innerHTML = 'â˜ ï¸';
          }
        }

        // æ¸…é™¤ä¹‹å‰çš„å›¾æ ‡
        if (!cell.classList.contains('selected') && !cell.classList.contains('your-poison')) {
          cell.innerHTML = '';
          cell.innerHTML = 'ğŸ°';
        }
      });
    }
    // å¤„ç†è›‹ç³•ç‚¹å‡»
    function handleCakeClick(row, col) {
      if (gameState === 'choosing_poison') {
        sendMessage('choose_poison', { position: [row, col] });
      } else if (gameState === 'playing') {
        sendMessage('select_cake', { position: [row, col] });
      }
    }

    function showAllPoisons(myPoison, opponentPoison) {
      const cakeCells = document.querySelectorAll('.cake-cell');

      cakeCells.forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);

        // æ ‡è®°è‡ªå·±çš„æ¯’è¯
        if (myPoison && myPoison[0] === row && myPoison[1] === col) {
          cell.classList.add('your-poison');
          cell.innerHTML = 'â˜ ï¸';
        }
        // æ ‡è®°å¯¹æ‰‹çš„æ¯’è¯
        else if (opponentPoison && opponentPoison[0] === row && opponentPoison[1] === col) {
          cell.classList.add('opponent-poison');
          cell.innerHTML = 'â˜ ï¸';
        }
      });
    }

    // æ˜¾ç¤ºæ¸¸æˆç»“æŸå±å¹•
    function showGameOver(data) {
      // document.getElementById('cake-grid-container').style.display = 'none';
      document.getElementById('game-over-screen').style.display = 'block';

      const winnerMessage = document.getElementById('winner-message');
      const resultDetails = document.getElementById('result-details');

      // æ˜¾ç¤ºæ¯’è¯ä½ç½®ï¼ˆæ¸¸æˆç»“æŸåæ˜¾ç¤ºæ‰€æœ‰æ¯’è¯ä½ç½®ï¼‰
      showAllPoisons(data.yourPoison, data.opponentPoison);

      if (data.winner === playerRole) {
        winnerMessage.innerHTML = '<i class="fas fa-crown"></i> ä½ èµ¢äº†!';
        resultDetails.innerHTML = `
            <p>æ­å–œï¼å¯¹æ‰‹é€‰ä¸­äº†æ¯’è¯ï¼</p>
            <p>ä½ çš„æ¯’è¯ä½ç½®: [${data.yourPoison[0] + 1}, ${data.yourPoison[1] + 1}]</p>
            <p>å¯¹æ‰‹çš„æ¯’è¯ä½ç½®: [${data.opponentPoison[0] + 1}, ${data.opponentPoison[1] + 1}]</p>
        `;
        playSound('win');
      } else {
        winnerMessage.innerHTML = '<i class="fas fa-skull-crossbones"></i> ä½ è¾“äº†!';
        if (data.isSelfPoison) {
          resultDetails.innerHTML = `
                <p>ä½ ä¸å°å¿ƒé€‰ä¸­äº†è‡ªå·±çš„æ¯’è¯ï¼</p>
                <p>ä½ çš„æ¯’è¯ä½ç½®: [${data.yourPoison[0] + 1}, ${data.yourPoison[1] + 1}]</p>
                <p>å¯¹æ‰‹çš„æ¯’è¯ä½ç½®: [${data.opponentPoison[0] + 1}, ${data.opponentPoison[1] + 1}]</p>
            `;
        } else {
          resultDetails.innerHTML = `
                <p>ä½ é€‰ä¸­äº†å¯¹æ‰‹çš„æ¯’è¯ï¼</p>
                <p>ä½ çš„æ¯’è¯ä½ç½®: [${data.yourPoison[0] + 1}, ${data.yourPoison[1] + 1}]</p>
                <p>å¯¹æ‰‹çš„æ¯’è¯ä½ç½®: [${data.opponentPoison[0] + 1}, ${data.opponentPoison[1] + 1}]</p>
            `;
        }
        playSound('lose');
      }
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    function initEventListeners() {
      // ä¸»èœå•æŒ‰é’®
      document.getElementById('create-room-btn').addEventListener('click', () => {
        showScreen('createRoom');
      });

      document.getElementById('join-room-btn').addEventListener('click', () => {
        showScreen('joinRoom');
      });

      // åˆ›å»ºæˆ¿é—´æŒ‰é’®
      document.getElementById('create-room-confirm-btn').addEventListener('click', () => {
        const roomIdInput = document.getElementById('room-id').value;
        // const gridSizeSelect = document.getElementById('grid-size').value;

        if (!/^\d{4}$/.test(roomIdInput)) {
          Toastify({
            text: "æˆ¿é—´å·å¿…é¡»æ˜¯4ä½æ•°å­—",
            duration: 3000,
            gravity: "top",
            position: "center",
            stopOnFocusLoss: true,
            style: {
              background: "linear-gradient(to right, #ff4757, #ff4757)",
            },
          }).showToast();
          // alert('æˆ¿é—´å·å¿…é¡»æ˜¯4ä½æ•°å­—');
          return;
        }

        // gridSize = parseInt(gridSizeSelect);
        sendMessage('create_room', { roomId: roomIdInput });
      });

      // åŠ å…¥æˆ¿é—´æŒ‰é’®
      document.getElementById('join-room-confirm-btn').addEventListener('click', () => {
        const roomIdInput = document.getElementById('join-room-id').value;

        if (!/^\d{4}$/.test(roomIdInput)) {
          Toastify({
            text: "æˆ¿é—´å·å¿…é¡»æ˜¯4ä½æ•°å­—",
            duration: 3000,
            gravity: "top",
            position: "center",
            stopOnFocusLoss: true,
            style: {
              background: "linear-gradient(to right, #ff4757, #ff4757)",
            },
          }).showToast();
          // alert('æˆ¿é—´å·å¿…é¡»æ˜¯4ä½æ•°å­—');
          return;
        }

        sendMessage('join_room', { roomId: roomIdInput });
      });

      // å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼ˆæˆ¿ä¸»è®¾ç½®ç½‘æ ¼å¤§å°åå¼€å§‹æ¸¸æˆï¼‰
      document.getElementById('start-game-btn').addEventListener('click', () => {
        const gridSizeSelect = document.getElementById('grid-size-select').value;
        gridSize = parseInt(gridSizeSelect);
        const who_go_first = document.getElementById('who-go-first-select').value;
        sendMessage('set_cakes', { gridSize: gridSize, who_go_first: who_go_first });
      });

      // è¿”å›æŒ‰é’®
      document.getElementById('back-to-menu-btn').addEventListener('click', () => {
        showScreen('mainMenu');
      });

      document.getElementById('back-to-menu-btn-2').addEventListener('click', () => {
        showScreen('mainMenu');
      });

      document.getElementById('cancel-waiting-btn').addEventListener('click', () => {
        // å‘é€ç¦»å¼€æˆ¿é—´çš„æ¶ˆæ¯
        if (ws && ws.readyState === WebSocket.OPEN && roomId) {
          sendMessage('leave_room', {});
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        resetGameState();

        // è¿”å›ä¸»èœå•
        showScreen('mainMenu');
      });

      // æ¸¸æˆæŒ‰é’®
      document.getElementById('play-again-btn').addEventListener('click', () => {
        sendMessage('restart_game', {});
      });

      document.getElementById('exit-game-btn').addEventListener('click', () => {
        // å‘é€ç¦»å¼€æˆ¿é—´çš„æ¶ˆæ¯
        if (ws && ws.readyState === WebSocket.OPEN && roomId) {
          sendMessage('leave_room', {});
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        resetGameState();

        // è¿”å›ä¸»èœå•
        showScreen('mainMenu');
      });

      // è¿”å›ä¸»èœå•æŒ‰é’®
      const backButtons = document.querySelectorAll('.btn-secondary');
      backButtons.forEach(button => {
        if (button.id.includes('back-to-menu')) {
          button.addEventListener('click', () => {
            // å¦‚æœå·²ç»åœ¨æˆ¿é—´ä¸­ï¼Œå…ˆç¦»å¼€æˆ¿é—´
            if (ws && ws.readyState === WebSocket.OPEN && roomId) {
              sendMessage('leave_room', {});
            }

            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetGameState();

            // è¿”å›ä¸»èœå•
            showScreen('mainMenu');
          });
        }
      });

      document.getElementById('sounds').addEventListener('click', () => {
        document.querySelector('#sounds .fas').classList.remove('fa-volume-up');
        document.querySelector('#sounds .fas').classList.remove('fa-volume-xmark');
        if (soundsEnabled) {
          document.querySelector('#sounds .fas').classList.add('fa-volume-xmark');
          soundsEnabled = false;
        } else {
          document.querySelector('#sounds .fas').classList.add('fa-volume-up');
          soundsEnabled = true;
        }
        localStorage.setItem('soundsEnabled', soundsEnabled);
      });

    }

    function handleRequestRestartGame(data) {
      console.log(data)
      Toastify({
        text: "å¯¹æ–¹ç©å®¶è¯·æ±‚é‡æ–°å¼€å§‹æ¸¸æˆ",
        duration: 3000,
        gravity: "top",
        position: "center",
        stopOnFocusLoss: true,
      }).showToast();
    }

    // æ·»åŠ é‡ç½®æ¸¸æˆçŠ¶æ€çš„å‡½æ•°
    function resetGameState() {
      playerRole = '';
      roomId = '';
      gridSize = 5;
      myPoisonPosition = null;
      gameState = '';
      isMyTurn = false;
      selectedCakes = new Set();

      // é‡ç½®æ‰€æœ‰è¾“å…¥å­—æ®µ
      document.getElementById('room-id').value = '';
      document.getElementById('join-room-id').value = '';

      // éšè—æ¸¸æˆç›¸å…³å…ƒç´ 
      document.getElementById('cake-grid-container').style.display = 'none';
      document.getElementById('game-over-screen').style.display = 'none';
      document.getElementById('game-setup').style.display = 'none';

      // é‡ç½®è›‹ç³•ç½‘æ ¼
      document.getElementById('cake-grid').innerHTML = '';

      // é‡ç½®çŠ¶æ€æ˜¾ç¤º
      document.getElementById('status-message').textContent = 'æ¸¸æˆå³å°†å¼€å§‹';
      document.getElementById('turn-indicator').textContent = '';
      document.getElementById('game-room-id').textContent = '----';
      document.getElementById('player-role').textContent = '---';
      document.getElementById('host-status').textContent = 'ç­‰å¾…ä¸­...';
      document.getElementById('guest-status').textContent = 'ç­‰å¾…ä¸­...';

      // ç§»é™¤ç©å®¶å¡ç‰‡çš„ç‰¹æ®Šæ ‡è®°
      document.getElementById('host-card').classList.remove('you');
      document.getElementById('host-card').querySelector('.score')?.remove();
      document.getElementById('guest-card').classList.remove('you');
      document.getElementById('guest-card').querySelector('.score')?.remove();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      connectWebSocket();
      initEventListeners();
      document.querySelector('#sounds .fas').classList.remove('fa-volume-up');
      document.querySelector('#sounds .fas').classList.remove('fa-volume-xmark');
      if (soundsEnabled) {
        document.querySelector('#sounds .fas').classList.add('fa-volume-up');
      } else {
        document.querySelector('#sounds .fas').classList.add('fa-volume-xmark');
      }
    });
  </script>
</body>

</html>